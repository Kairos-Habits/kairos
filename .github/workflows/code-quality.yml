name: Code Quality Checks

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths:
      - "**/*.kt"
      - "**/*.gradle.kts"
      - "gradle/libs.versions.toml"
      - "config/detekt/**"
  push:
    branches:
      - main
    paths:
      - "**/*.kt"
      - "**/*.gradle.kts"
      - "gradle/libs.versions.toml"
      - "config/detekt/**"

jobs:
  code-quality:
    name: Formatting, Linting & Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check code formatting with Spotless
        run: ./gradlew spotlessCheck --no-daemon --stacktrace
        continue-on-error: false

      - name: Run Detekt static analysis
        run: ./gradlew detekt --no-daemon --stacktrace
        continue-on-error: false

      - name: Upload Detekt reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-reports
          path: |
            **/build/reports/detekt/
          retention-days: 7

      - name: Check ADHD-first language compliance
        if: always()
        shell: bash
        run: |
          echo "üîç Checking for shame-inducing language in UI modules..."

          # Get changed files in UI modules
          # Note: Using git commands with trusted refs only, no user input
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E '(app|wear|ui-shared)/src/main/.*\.kt$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No UI files changed"
            exit 0
          fi

          echo "Checking files:"
          echo "$CHANGED_FILES" | sed 's/^/  - /'
          echo ""

          # Check for forbidden terms
          FORBIDDEN_TERMS="streak|failure|failed|miss(?!ion)|missed|perfect(?!ly valid)"
          VIOLATIONS=$(echo "$CHANGED_FILES" | xargs grep -nE "$FORBIDDEN_TERMS" 2>/dev/null || true)

          if [ -z "$VIOLATIONS" ]; then
            echo "‚úÖ ADHD-first language check passed"
            exit 0
          else
            echo "‚ö†Ô∏è Found potentially shame-inducing language:"
            echo "$VIOLATIONS"
            echo ""
            echo "Please use shame-free alternatives:"
            echo "  - 'streak' ‚Üí 'rhythm' or 'pattern'"
            echo "  - 'failure/failed' ‚Üí 'lapse' or 'pause'"
            echo "  - 'miss/missed' ‚Üí 'skip' or 'pause'"
            echo ""
            echo "See .claude/skills/adhd-first-review/SKILL.md for full guidelines"
            exit 1
          fi

      # Note: Using actions/github-script for safe API interaction
      # This does NOT execute shell commands with untrusted input
      - name: Comment PR with Detekt results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## üî¨ Code Quality Check Results\n\n';

            // Check if Detekt report exists
            const detektReportPath = 'build/reports/detekt/detekt.md';
            if (fs.existsSync(detektReportPath)) {
              const detektReport = fs.readFileSync(detektReportPath, 'utf8');
              comment += '### Detekt Issues\n\n';
              comment += detektReport;
            }

            comment += '\n\n---\n';
            comment += '**Fix these issues before merging.**\n';
            comment += '- Run `./gradlew spotlessApply` to fix formatting\n';
            comment += '- Run `./gradlew detekt` locally to see detailed issues\n';
            comment += '- Review ADHD-first language guidelines in `.claude/skills/adhd-first-review/`\n';

            // Using GitHub API - no shell command execution with user input
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build debug APK
        run: ./gradlew :app:assembleDebug --no-daemon --stacktrace

      - name: Run unit tests
        run: ./gradlew test --no-daemon --stacktrace

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 7

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7
